<!--
Sync Impact Report:
- Version change: 3.0.0 → 3.1.0
- List of modified principles:
  - (All Phase II principles retained unchanged)
- Added sections:
  - VI. Phase II Sacred Codebase (NEW - immutability mandate)
  - VII. Additive Phase III Architecture (NEW - extension rules)
  - VIII. Stateless AI Interaction (NEW - statelessness for AI layer)
  - IX. MCP-First Tool Interface (NEW - MCP as sole action interface)
  - X. Security & User Isolation (Enhanced - expanded for chatbot context)
- Removed sections: none
- Templates requiring updates:
  - ✅ updated: .specify/memory/constitution.md
  - ⚠ pending: .specify/templates/plan-template.md (Constitution Check section already compatible)
- Follow-up TODOs: none
-->

# Habit Tracker & Goal Management Web App Constitution (Phase II + III)

## Core Principles

### I. Spec-First Development & Automated Execution
This project MUST strictly follow the Spec-Kit Plus workflow: Constitution → Specifications → Plan → Tasks → Implementation. No feature code should be written without an associated finalized and approved specification and implementation plan. Crucially, all code must be generated by Claude Code; no manual coding is permitted. Use `@specs/...` shorthand when referencing design documents.

### II. Non-Negotiable Approval
No implementation of features, infrastructure, or architectural changes may proceed without explicit user approval of the implementation plan (`plan.md`) and task list (`tasks.md`). This gate ensures technical alignment and prevents unapproved deviations.

### III. Security & Data Isolation (JWT Mandatory)
Authentication is mandatory for all API access. Every API request MUST require JWT authentication via the `Bearer <token>` header. The backend MUST independently verify JWTs using a shared secret provided via environment variables. User data isolation is critical; users must only access their own data. The backend MUST verify the token and ensure the authenticated user matches the requested resources (e.g., verifying `user_id` in URLs). Requests without a valid JWT MUST return a 401 Unauthorized status.

### IV. Analytics Integrity
Accuracy in habit tracking and streak calculations is critical. The system MUST provide reliable daily tracking, automatic recursive streak logic, and precise weekly/monthly summaries. Analytics calculations must be verified against the source of truth data before any release.

### V. Modern Animated UI (Yellow & Orange Theme)
A high-quality, responsive, and animated user interface is a core requirement. All frontend components MUST leverage Framer Motion for meaningful transitions. The application MUST follow a modern "Yellow & Orange" gradient theme. Tailwind CSS is the mandatory standard for styling.

### VI. Phase II Sacred Codebase
Phase II code is SACRED and IMMUTABLE. The todo and habit management APIs, database schemas, and business logic from Phase II MUST NOT be modified. Any Phase III feature that requires new data structures MUST create new tables rather than altering existing ones. This principle ensures zero regression risk for core functionality.

### VII. Additive Phase III Architecture
Phase III extends Phase II through ADDITIVE patterns only. New features must:
- Create new endpoints rather than modifying existing ones
- Add new database tables for chatbot-related data (conversation_sessions, messages, etc.)
- Never change Phase II API signatures or return types
- Never perform breaking schema migrations on Phase II tables

### VIII. Stateless AI Interaction
The AI chatbot layer MUST be fully stateless:
- The server holds NO in-memory conversation state
- All conversation history MUST be persisted to the database
- Every chat request MUST be self-contained with all context
- Server instances MUST be interchangeable (no session affinity)
- This enables horizontal scaling and fault tolerance

### IX. MCP-First Tool Interface
AI agents MUST NEVER interact with the database directly:
- ALL database actions MUST route through MCP (Model Context Protocol) tools
- MCP tools MUST be deterministic and stateless
- MCP tool signatures MUST map directly to existing Phase II task APIs
- No direct database queries, ORM calls, or SQL execution from AI agents
- This ensures predictable, auditable, and testable AI behavior

### X. Mandatory Technology Stack (Phase III)

- **AI Framework**: OpenAI Agents SDK
- **AI Model**: Gemini 2.5 Flash (via `GEMINI_API_KEY` environment variable)
- **Chat Endpoint**: Stateless FastAPI endpoint
- **Conversation Storage**: Database-persisted sessions and messages
- **Tool Interface**: MCP tools exclusively

## Technology Stack (Mandatory)

- **Frontend**: Next.js 16+ (App Router), TypeScript, Tailwind CSS, Framer Motion, Better Auth
- **Backend**: Python FastAPI, SQLModel ORM, JWT Verification Middleware
- **Database**: Neon Serverless PostgreSQL

## Governance

### Amendment Procedure
This constitution is the supreme governing document. Amendments require an explicit proposal and user approval.

### Versioning Policy
- **MAJOR**: Backward incompatible governance or principal requirement changes.
- **MINOR**: New principles or material technology stack updates.
- **PATCH**: Wording improvements or non-semantic refinements.

### Compliance Review
Every implementation plan and task must be reviewed against these principles. Violations are not permitted without an approved amendment.

**Version**: 3.1.0 | **Ratified**: 2025-12-30 | **Last Amended**: 2026-01-02
